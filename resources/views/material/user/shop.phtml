<?php include(TEMPLATE_PATH . 'user/main.phtml'); ?>

    <main class="content">
        <div class="content-header ui-content-header">
            <div class="container">
                <h1 class="content-heading">商品列表</h1>
            </div>
        </div>
        <div class="container">
            <div class="col-lg-12 col-sm-12">
                <section class="content-inner margin-top-no">

                    <div class="card">
                        <div class="card-main">
                            <div class="card-inner">
                                <p>系统中所有商品的列表。您购买等级类的商品时有效期会从当前时间开始计算。</p>
                                <p>当前余额：<?= $user->money; ?> 元</p>
                            </div>
                        </div>
                    </div>

                    <div class="ui-card-wrap">
                    <div class="row">
                        <div class="col-lg-12 col-sm-12">
                            <div class="card">
                                <div class="card-main">
                                    <div class="card-inner margin-bottom-no">
                                        <div class="tile-wrap">
<?php foreach ($shops as $shop) { ?>
                                                <div class="tile tile-collapse">

                                                    <div data-toggle="tile" data-target="#heading<?= $shop->id; ?>">
                                                        <div class="tile-side pull-left" data-ignore="tile">
                                                            <div class="avatar avatar-sm">
                                                                <span class="icon shop">shop</span>
                                                            </div>
                                                        </div>
                                                        <div class="tile-inner">
                                                            <div class="text-overflow">#<?= $shop->id; ?> <?= $shop->name; ?> <span class="label label-brand-accent"><?= $shop->price; ?> 元</span></div>
                                                        </div>
                                                    </div>

                                                    <div class="collapsible-region collapse" id="heading<?= $shop->id; ?>">
                                                        <div class="tile-sub">
                                                            <br />
                                                            <div class="card">
                                                                <div class="card-main">
                                                                    <div class="card-inner">
                                                                        <p class="card-heading">
                                                                            <a>#<?= $shop->id; ?> <?= $shop->name; ?></a><span class="label label-brand-accent"><?= $shop->price; ?> 元</span>
                                                                        </p>
                                                                        <hr />
                                                                        <p class="card-heading">商品内容</p>
                                                                        <?= $shop->content(); ?>
                                                                        <p class="card-heading">自动续费</p>
<?php if ($shop->auto_renew == 0) { ?>
                                                                        不能自动续费
<?php } else { ?>
                                                                        在 <span class="label label-brand-red"><?= $shop->auto_renew; ?></span> 天后自动续费（可选）
<?php } ?>
                                                                        <p class="card-heading">续费时流量重置</p>
                                                                        <span class="label label-brand"><?php if ($shop->auto_reset_bandwidth == 0) { ?>不自动重置<?php } else { ?>自动重置<?php } ?></span>
                                                                        <hr />
                                                                        <p><a class="btn btn-brand-accent" href="javascript:void(0);" onClick="buy('<?= $shop->id; ?>',<?= $shop->auto_renew; ?>,<?= $shop->auto_reset_bandwidth; ?>)"><span class="icon shopping_cart">shopping_cart</span> 购买</a></p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
<?php } ?>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div aria-hidden="true" class="modal modal-va-middle fade" id="nodeinfo" role="dialog" tabindex="-1">
                            <div class="modal-dialog modal-full">
                                <div class="modal-content">
                                    <iframe class="iframe-seamless" title="Modal with iFrame" id="infoifram"></iframe>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>


                    <div aria-hidden="true" class="modal modal-va-middle fade" id="coupon_modal" role="dialog" tabindex="-1">
                        <div class="modal-dialog modal-xs">
                            <div class="modal-content">
                                <div class="modal-heading">
                                    <a class="modal-close" data-dismiss="modal">×</a>
                                    <h2 class="modal-title">您有优惠码吗？</h2>
                                </div>
                                <div class="modal-inner">
                                    <div class="form-group form-group-label">
                                        <label class="floating-label" for="coupon">有的话，请在这里输入。没有的话，直接确定吧</label>
                                        <input class="form-control" id="coupon" type="text">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <p class="text-right"><button class="btn btn-flat btn-brand waves-attach" data-dismiss="modal" id="coupon_input" type="button">确定</button></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div aria-hidden="true" class="modal modal-va-middle fade" id="order_modal" role="dialog" tabindex="-1">
                        <div class="modal-dialog modal-xs">
                            <div class="modal-content">
                                <div class="modal-heading">
                                    <a class="modal-close" data-dismiss="modal">×</a>
                                    <h2 class="modal-title">订单确认</h2>
                                </div>
                                <div class="modal-inner">
                                    <p id="name">商品名称：</p>
                                    <p id="credit">优惠额度：</p>
                                    <p id="total">总金额：</p>
                                    <p id="auto_reset">在到期时自动续费</p>

                                    <div class="checkbox switch" id="autor">
                                        <label for="autorenew">
                                            <input checked class="access-hide" id="autorenew" type="checkbox"><span class="switch-toggle"></span>自动续费
                                        </label>
                                    </div>

                                </div>

                                <div class="modal-footer">
                                    <p class="text-right"><button class="btn btn-flat btn-brand waves-attach" data-dismiss="modal" id="order_input" type="button">确定</button></p>
                                </div>
                            </div>
                        </div>
                    </div>

<?php include(TEMPLATE_PATH . 'dialog.phtml'); ?>

            </div>

        </div>
    </main>

<?php include(TEMPLATE_PATH . 'user/footer.phtml'); ?>


<script>
function buy(id,auto,auto_reset) {
    auto_renew=auto;
    if(auto==0)
    {
        document.getElementById('autor').style.display="none";
    }
    else
    {
        document.getElementById('autor').style.display="";
    }

    if(auto_reset==0)
    {
        document.getElementById('auto_reset').style.display="none";
    }
    else
    {
        document.getElementById('auto_reset').style.display="";
    }

    shop=id;
    $("#coupon_modal").modal();
}


$("#coupon_input").click(function () {
        $.ajax({
            type: "POST",
            url: "coupon_check",
            dataType: "json",
            data: {
                coupon: $("#coupon").val(),
                shop: shop
            },
            success: function (data) {
                if (data.ret) {
                    $("#name").html("商品名称："+data.name);
                    $("#credit").html("优惠额度："+data.credit);
                    $("#total").html("总金额："+data.total);
                    $("#order_modal").modal();
                } else {
                    $("#result").modal();
                    $("#msg").html(data.msg);
                }
            },
            error: function (jqXHR) {
                $("#result").modal();
                $("#msg").html(data.msg+"  发生了错误。");
            }
        })
    });

$("#order_input").click(function () {

        if(document.getElementById('autorenew').checked)
        {
            var autorenew=1;
        }
        else
        {
            var autorenew=0;
        }

        $.ajax({
            type: "POST",
            url: "buy",
            dataType: "json",
            data: {
                coupon: $("#coupon").val(),
                shop: shop,
                autorenew: autorenew
            },
            success: function (data) {
                if (data.ret) {
                    $("#result").modal();
                    $("#msg").html(data.msg);
                    window.setTimeout("location.href='/user/shop'", <?= $_ENV['jump_delay']; ?>);
                } else {
                    $("#result").modal();
                    $("#msg").html(data.msg);
                }
            },
            error: function (jqXHR) {
                $("#result").modal();
                $("#msg").html(data.msg+"  发生了错误。");
            }
        })
    });

</script>